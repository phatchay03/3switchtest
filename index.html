<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>3-Gang Switch IFrame</title>
  <style>
    :root{
      --bg:#f5f7fb; --plate:#ffffff; --stroke:#d5d9e2;
      --text:#0f172a; --muted:#64748b;
      --on:#22c55e; --off:#94a3b8;
      --ind-on:#3b82f6; --ind-off:#cbd5e1;
    }
    html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;}
    .wrap{height:100%;display:grid;place-items:center;padding:8px;}
    .panel{
      width:min(92vw,420px); aspect-ratio:1/1; background:var(--plate);
      border-radius:14px; box-shadow:0 6px 22px rgba(2,6,23,.12);
      display:grid; grid-template-columns:repeat(3,1fr); overflow:hidden;
      border:1px solid var(--stroke);
    }
    .key{
      position:relative;
      /* Cấu trúc lưới chung cho tất cả các nút: Nút bấm, Label, Dot */
      display:grid; grid-template-rows:1fr auto 16px; align-items:end;
      border-left:1px solid var(--stroke);
      transition:background 0.2s;
    }
    .key:first-child{border-left:none;}

    /* Styling cho tất cả các nút bấm */
    .btn{
      margin:14px; border-radius:10px; border:1px solid var(--stroke);
      background:linear-gradient(#ffffff,#f3f6fb);
      box-shadow: inset 0 1px 0 #fff, 0 2px 6px rgba(15,23,42,.08);
      cursor:pointer; outline:none; transition:all .15s ease;
      height:90%;
    }
    .btn:active{transform:scale(0.98);}
    .label{
      text-align:center; font-size:14px; color:var(--muted); margin-bottom:8px;
      letter-spacing:.3px; user-select:none;
    }
    .dot{
      height:4px; width:24px; border-radius:999px; margin:0 auto 12px;
      background:var(--ind-off); transition:background-color .18s ease;
    }
    /* Visual trạng thái ON (chung cho tất cả) */
    .key.on .btn{background:linear-gradient(#d9ffe7,#afffcb); border-color:#b7efc5;}
    .key.on .label{color:var(--on); font-weight:600;}
    .key.on .dot{background:var(--ind-on);}
    .btn:focus-visible{box-shadow:0 0 0 3px rgba(59,130,246,.35);}
    .head{
      position:absolute; top:8px; right:12px; color:#94a3b8; font-size:11px; letter-spacing:.2px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="panel" id="panel">
      <div class="head">
        <span id="deviceId">device-unknown</span>
      </div>

      <!-- SWITCH 1: Nút bấm gốc -->
      <div class="key" id="sw1">
        <button class="btn" id="btn-sw1">1</button>
        <div class="label" id="status-sw1">OFF</div>
        <div class="dot"></div>
      </div>

      <!-- SWITCH 2: Nút bấm gốc -->
      <div class="key" id="sw2">
        <button class="btn" id="btn-sw2">2</button>
        <div class="label" id="status-sw2">OFF</div>
        <div class="dot"></div>
      </div>

      <!-- SWITCH 3: Nút bấm gốc -->
      <div class="key" id="sw3">
        <button class="btn" id="btn-sw3">3</button>
        <div class="label" id="status-sw3">OFF</div>
        <div class="dot"></div>
      </div>
    </div>
  </div>
  <!-- Thêm thư viện EraWidget cho chức năng -->
  <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
  <script>
    // Hằng số cho các ID công tắc
    const switches = ["sw1", "sw2", "sw3"];
    // Trạng thái UI (false/true)
    const state = { sw1: false, sw2: false, sw3: false };

    // Dữ liệu và cấu hình EraWidget cho từng công tắc
    const eraData = {
        // configIdx, onIdx, offIdx là chỉ số được giả định trong mảng configs và actions từ server
        sw1: { config: null, status: 0, onAction: null, offAction: null, configIdx: 0, onIdx: 0, offIdx: 1 },
        sw2: { config: null, status: 0, onAction: null, offAction: null, configIdx: 1, onIdx: 2, offIdx: 3 },
        sw3: { config: null, status: 0, onAction: null, offAction: null, configIdx: 2, onIdx: 4, offIdx: 5 },
    };
    let eraWidget = null;

    /**
     * Cập nhật giao diện hình ảnh của công tắc (chung cho tất cả 3 nút).
     * @param {string} id - ID công tắc ('sw1', 'sw2', 'sw3').
     */
    function render(id) {
      const on = state[id];
      const key = document.getElementById(id);
      const status = document.getElementById(`status-${id}`);

      // Cập nhật class 'on' để thay đổi màu nền và đèn báo
      key.classList.toggle("on", on);
      // Cập nhật trạng thái chữ
      status.textContent = on ? "ON" : "OFF";
    }

    /**
     * Kích hoạt hành động EraWidget cho một công tắc.
     * @param {string} id - ID công tắc ('sw1', 'sw2', 'sw3').
     */
    function handleEraAction(id) {
        const data = eraData[id];

        if (data.onAction && data.offAction) {
            // Nếu đang ON (1), kích hoạt hành động OFF
            if (data.status === 1) {
                eraWidget.triggerAction(data.offAction, null);
            } else {
                // Nếu đang OFF (0), kích hoạt hành động ON
                eraWidget.triggerAction(data.onAction, null);
            }
        } else {
            // Fallback an toàn (sử dụng logic postMessage ban đầu)
            console.warn(`Actions not fully loaded for ${id}. Falling back to postMessage logic.`);
            state[id] = !state[id];
            render(id);
            window.parent?.postMessage({ type: "era:command", id, value: state[id] }, "*");
        }
    }

    // --- Logic EraWidget cho tất cả các công tắc ---
    if (typeof EraWidget !== 'undefined') {
        eraWidget = new EraWidget();
        eraWidget.init({
            needRealtimeConfigs: true,
            needActions: true,
            maxRealtimeConfigsCount: 3, // Cần 3 cấu hình
            maxActionsCount: 6,         // Cần 6 hành động (3 cặp ON/OFF)
            minRealtimeConfigsCount: 0, // Cho phép cấu hình tối thiểu 0 (để tránh lỗi nếu chưa cấu hình đủ)
            minActionsCount: 0,         // Cho phép hành động tối thiểu 0

            onConfiguration: (configuration) => {
                const configs = configuration.realtime_configs;
                const actions = configuration.actions;
                const switchIds = ['sw1', 'sw2', 'sw3'];

                switchIds.forEach((id) => {
                    const data = eraData[id];
                    
                    // Gán cấu hình
                    if (configs[data.configIdx]) {
                        data.config = configs[data.configIdx];
                    }

                    // Gán hành động (ON/OFF)
                    if (actions[data.onIdx]) {
                        data.onAction = actions[data.onIdx].action;
                    }
                    if (actions[data.offIdx]) {
                        data.offAction = actions[data.offIdx].action;
                    }
                });
            },

            onValues: (values) => {
                const switchIds = ['sw1', 'sw2', 'sw3'];

                switchIds.forEach(id => {
                    const data = eraData[id];

                    if (data.config && values[data.config.id]) {
                        const stateLed = values[data.config.id].value; // Giá trị: 0 (OFF) hoặc 1 (ON)

                        if (data.status !== stateLed) {
                            data.status = stateLed;
                            state[id] = !!stateLed; // Cập nhật trạng thái UI (boolean)
                            render(id);
                        }
                    }
                });
            },
        });

        // Event Listener cho tất cả các nút: Kích hoạt hành động EraWidget
        document.getElementById('btn-sw1').addEventListener('click', () => handleEraAction('sw1'));
        document.getElementById('btn-sw2').addEventListener('click', () => handleEraAction('sw2'));
        document.getElementById('btn-sw3').addEventListener('click', () => handleEraAction('sw3'));

    } else {
        // Fallback: Nếu EraWidget không được tải, tất cả các nút đều dùng logic postMessage
        console.error("EraWidget library not found. Falling back to postMessage for all switches.");
        
        /**
         * Chuyển đổi trạng thái của công tắc, cập nhật giao diện và gửi lệnh.
         * Dùng làm FALLBACK khi EraWidget không hoạt động.
         * @param {string} id - ID công tắc.
         */
        function fallbackToggle(id) {
            state[id] = !state[id];
            render(id);
            window.parent?.postMessage({ type: "era:command", id, value: state[id] }, "*");
        }

        document.getElementById('btn-sw1').addEventListener('click', () => fallbackToggle('sw1'));
        document.getElementById('btn-sw2').addEventListener('click', () => fallbackToggle('sw2'));
        document.getElementById('btn-sw3').addEventListener('click', () => fallbackToggle('sw3'));
    }
    // -----------------------------

    // Render trạng thái ban đầu cho tất cả
    switches.forEach(id => render(id));


    // Trình lắng nghe tin nhắn từ cửa sổ cha (cập nhật trạng thái từ bên ngoài)
    window.addEventListener("message", (event) => {
      const msg = event.data || {};

      // Xử lý cập nhật công tắc đơn lẻ (era:update)
      if (msg.type === "era:update" && switches.includes(msg.id)) {
        state[msg.id] = !!msg.value; // Chuyển giá trị thành boolean
        render(msg.id);
      }

      // Xử lý cập nhật hàng loạt (era:batch)
      if (msg.type === "era:batch" && msg.data) {
        // Cập nhật tất cả các công tắc có trong dữ liệu
        switches.forEach(k => {
          if (k in msg.data) {
            state[k] = !!msg.data[k];
            render(k);
          }
        });
        // Cập nhật ID thiết bị nếu có
        if (msg.deviceId) document.getElementById("deviceId").textContent = msg.deviceId;
      }
    });
  </script>
</body>
</html>
